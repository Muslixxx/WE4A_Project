{% extends 'base.html.twig' %}

{# Titre de la page #}
{% block title %}Menu Principal{% endblock %}

{# Corps de la page principale #}
{% block body %}
    <style>
        {# Style pour ajouter un effet d'overlay au survol des cartes de cours #}
        .custom-card {
            position: relative;
            overflow: hidden;
        }

        .custom-card .card-overlay {
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
        }

        .custom-card:hover .card-overlay {
            opacity: 1;
            pointer-events: auto;
        }
    </style>

    <div class="container d-flex flex-column align-items-center" style="min-height: 100vh; gap: 1rem; padding: 2rem;">

        {# === Carte de bienvenue utilisateur === #}
        <div class="card w-100 bg-blue-darker" style="border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <div class="card-body text-center">
                <h1 class="card-title" style="font-family: 'Luckiest Guy'; color: #fff;">
                    Menu Principal
                </h1>
                <p style="color: #fff;">
                    Bienvenue sur Moodneuille, vous Ãªtes connectÃ© en tant que
                    {% if app.user.role == 'ROLE_ELEVE' %}
                        Ã©lÃ¨ve.
                    {% else %}
                        prof.
                    {% endif %}
                </p>
            </div>
        </div>

        {# === Section affichage des cours auxquels l'utilisateur est inscrit === #}
        <div class="card w-100 bg-blue-darker" style="border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <div class="card-header text-center" style="background: transparent; border-bottom: none;">
                <h2 style="color: #fff;">Cours</h2>
            </div>
            <div class="card-body">
                <div class="row justify-content-center">
                    {% for course in courses %}
                        <div class="col-12 col-sm-6 col-md-4 mb-4 d-flex justify-content-center">
                            {# Carte pour chaque cours avec overlay interactif #}
                            <div class="card custom-card" style="background-color: rgba(255,255,255,0.15); width: 100%;">
                                <div class="card-content p-3 text-center">
                                    <h3 style="color: #fff;">{{ course.name }}</h3>
                                    <p style="color: #fff;">{{ course.description }}</p>
                                </div>
                                <div class="card-overlay">
                                    <a href="{{ path('course_detail', {'id': course.id}) }}" class="btn btn-primary">
                                        AccÃ©der au cours
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {# === Section affichage des posts rÃ©cents liÃ©s aux cours === #}
        <div class="card w-100 bg-blue-darker" style="border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <div class="card-header text-center" style="background: transparent; border-bottom: none;">
                <h2 style="font-family: 'Luckiest Guy'; color: #fff;">ActivitÃ©s rÃ©centes</h2>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% if recentPosts|length > 0 %}
                        {% for post in recentPosts %}
                            {# Affiche chaque post rÃ©cent sous forme de carte stylisÃ©e #}
                            <div class="list-group-item" style="background-color: rgba(255,255,255,0.15); border: none; margin-bottom: 0.5rem;">
                                <small class="text-muted">{{ post.dateCreation|date('d/m/Y H:i') }}</small>
                                <p class="mb-0" style="color: #fff;">
                                    {{ post.user.firstName }} {{ post.user.lastName }} a postÃ©
                                    {% if post.type == 'document' %}
                                        un fichier
                                    {% elseif post.type == 'link' %}
                                        un lien
                                    {% else %}
                                        un message
                                    {% endif %}
                                    Â« {{ post.title }}
                                    {% if post.isImportant %}
                                        <span title="Post Important">ðŸ“Œ</span>
                                    {% endif %}
                                    Â» dans {{ post.course.name }}
                                </p>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: #fff;">Aucune activitÃ© rÃ©cente.</p>
                    {% endif %}
                </div>

                {# Bouton charger pour afficher plus de post #}
                <div class="text-center mt-3">
                    <button id="loadMoreBtn" class="btn btn-outline-light">Charger plus d'actualitÃ©s</button>
                </div>
            </div>
        </div>

    </div>
{% endblock %}

{% block javascripts %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const listGroup = document.querySelector('.list-group');

            loadMoreBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('{{ path('menu_load_more_posts') }}');
                    const posts = await response.json();

                    listGroup.innerHTML = ''; // Vide l'affichage existant

                    posts.forEach(post => {
                        const item = document.createElement('div');
                        item.classList.add('list-group-item');
                        item.style.backgroundColor = 'rgba(255,255,255,0.15)';
                        item.style.border = 'none';
                        item.style.marginBottom = '0.5rem';

                        item.innerHTML = `
                            <small class="text-muted">${post.date}</small>
                            <p class="mb-0" style="color: #fff;">
                                ${post.firstName} ${post.lastName} a postÃ©
                                ${post.type === 'document' ? 'un fichier' : (post.type === 'link' ? 'un lien' : 'un message')}
                                Â« ${post.title} ${post.isImportant ? '<span title="Post Important">ðŸ“Œ</span>' : ''} Â»
                                dans ${post.courseName}
                            </p>
                        `;

                        listGroup.appendChild(item);
                    });
                    loadMoreBtn.style.display = 'none'; // Cache le bouton aprÃ¨s chargement
                } catch (error) {
                    console.error('Erreur lors du chargement des posts:', error);
                }
            });
        });
    </script>
{% endblock %}
