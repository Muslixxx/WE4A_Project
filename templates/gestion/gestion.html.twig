{% extends 'base.html.twig' %}

{% block title %}Paramètres {{ app.user.firstName }} {{ app.user.lastName }}{% endblock %}

{% set fixed_page = true %}

{% block body %}
    <div class="container d-flex justify-content-center align-items-center" style="min-height: 60vh; padding: 2rem;">

        <div style="background-color: #42a5f5; border-radius: 15px; width: 80vw; max-width: 800px; min-height: 50vh; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); padding: 2rem;">
            <!-- Titre -->
            <h1 style="font-family: 'Luckiest Guy', cursive; font-size: 2.2rem; color: #fff; text-shadow: 2px 2px 0 #0003; text-align: center; margin-bottom: 1rem;">
                Mon Profil
            </h1>

            <div style="margin: 0 auto; max-width: 600px; font-family: 'Comic Neue', cursive; color: #fff;">

                <!-- Nom complet (non modifiable) -->
                <div style="margin-bottom: 1rem;">
                    <label>Nom complet</label>
                    <input type="text" value="{{ app.user.firstName }} {{ app.user.lastName }}" readonly
                           style="width: 100%; padding: 0.5rem; border-radius: 8px; border: none; background-color: rgba(255,255,255,0.2); color: #fff;"/>
                </div>

                <!-- Identifiant (email, non modifiable) -->
                <div style="margin-bottom: 1rem;">
                    <label>Identifiant (email)</label>
                    <input type="email" value="{{ app.user.email }}" readonly
                           style="width: 100%; padding: 0.5rem; border-radius: 8px; border: none; background-color: rgba(255,255,255,0.2); color: #fff;"/>
                </div>

                <!-- Mot de passe avec boutons "Modifier" et "Afficher" -->
                <div style="margin-bottom: 1rem;">
                    <label>Mot de passe</label>
                    <input type="password" id="password" value="********" readonly
                           style="width: 100%; padding: 0.5rem; border-radius: 8px; border: none; background-color: rgba(255,255,255,0.2); color: #fff;"/>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <button type="button" id="toggleEditPassword" class="btn btn-primary btn-sm">Modifier</button>
                        <button type="button" id="toggleShowPassword" class="btn btn-primary btn-sm">Afficher</button>
                    </div>
                </div>

                <!-- Type d'utilisateur (non modifiable) -->
                <div style="margin-bottom: 1rem;">
                    <label>Type d'utilisateur</label>
                    <input type="text"
                           value="{% if app.user.role == 'ROLE_ADMIN' %}Administrateur{% elseif app.user.role == 'ROLE_PROF' %}Professeur{% else %}Élève{% endif %}"
                           readonly
                           style="width: 100%; padding: 0.5rem; border-radius: 8px; border: none; background-color: rgba(255,255,255,0.2); color: #fff;"/>
                </div>

                <div style="text-align: right; margin-top: 2rem;">
                    <button id="saveButton" class="btn btn-success">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const passwordInput = document.getElementById('password');
            const toggleEdit = document.getElementById('toggleEditPassword');
            const toggleShow = document.getElementById('toggleShowPassword');

            toggleEdit.addEventListener('click', () => {
                if (passwordInput.hasAttribute('readonly')) {
                    passwordInput.removeAttribute('readonly');
                    passwordInput.value = '';
                    toggleEdit.textContent = 'Verrouiller';
                    passwordInput.style.backgroundColor = '#fff';
                    passwordInput.style.color = '#000';
                } else {
                    passwordInput.setAttribute('readonly', true);
                    passwordInput.value = '********';
                    toggleEdit.textContent = 'Modifier';
                    passwordInput.style.backgroundColor = 'rgba(255,255,255,0.2)';
                    passwordInput.style.color = '#fff';
                }
            });

            toggleShow.addEventListener('click', () => {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleShow.textContent = 'Cacher';
                } else {
                    passwordInput.type = 'password';
                    toggleShow.textContent = 'Afficher';
                }
            });

            document.getElementById('saveButton').addEventListener('click', () => {
                if (!passwordInput.hasAttribute('readonly') && passwordInput.value.trim() !== '') {
                    fetch('{{ path('update_password') }}', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({password: passwordInput.value})
                    })
                        .then(response => response.json())
                        .then(data => alert('Mot de passe mis à jour !'));
                } else {
                    alert('Aucun changement à enregistrer.');
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const saveButton = document.getElementById('saveButton');
            const passwordInput = document.getElementById('password');

            saveButton.addEventListener('click', async function (e) {
                e.preventDefault();

                const password = passwordInput.value;

                if (!password || password.length < 6) {
                    alert("Le mot de passe doit contenir au moins 6 caractères.");
                    return;
                }

                try {
                    const response = await fetch('{{ path('update_password') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                        body: JSON.stringify({ password })
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        alert("Mot de passe mis à jour avec succès !");
                        window.location.href = "{{ path('app_menu') }}";
                    } else {
                        alert("Erreur : " + result.message);
                    }

                } catch (err) {
                    alert("Erreur de communication avec le serveur.");
                    console.error(err);
                }
            });
        });
    </script>

{% endblock %}
